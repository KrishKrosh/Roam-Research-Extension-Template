"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createComponentRender = void 0;
const tslib_1 = require("tslib");
const core_1 = require("@blueprintjs/core");
const react_1 = tslib_1.__importStar(require("react"));
const react_dom_1 = tslib_1.__importDefault(require("react-dom"));
const dom_1 = require("../dom");
const ComponentContainer = ({ blockId, className, children }) => {
    const [showIcons, setShowIcons] = (0, react_1.useState)(false);
    const appear = (0, react_1.useCallback)(() => setShowIcons(true), [setShowIcons]);
    const disappear = (0, react_1.useCallback)(() => setShowIcons(false), [setShowIcons]);
    return (react_1.default.createElement("div", { className: className, onMouseOver: appear, onMouseLeave: disappear, style: { position: "relative", width: "fit-content", minWidth: 300 } },
        showIcons && (react_1.default.createElement("div", { style: { position: "absolute", top: 8, right: 8, zIndex: 1000 } }, blockId && (react_1.default.createElement(core_1.Button, { icon: "edit", minimal: true, onClick: () => (0, dom_1.openBlock)(blockId) })))),
        children));
};
const renderWithUnmount = (el, p) => {
    react_dom_1.default.render(el, p);
    const unmountObserver = new MutationObserver((ms) => {
        const parentRemoved = ms
            .flatMap((m) => Array.from(m.removedNodes))
            .some((n) => n === p || n.contains(p));
        if (parentRemoved) {
            unmountObserver.disconnect();
            react_dom_1.default.unmountComponentAtNode(p);
        }
    });
    unmountObserver.observe(document.body, { childList: true, subtree: true });
};
const createComponentRender = (Fc, className) => (b) => {
    var _a, _b;
    if (b.parentElement) {
        b.parentElement.onmousedown = (e) => e.stopPropagation();
        const blockUid = (0, dom_1.getBlockUidFromTarget)(b);
        const possibleBlockId = (_a = b.closest(".roam-block")) === null || _a === void 0 ? void 0 : _a.id;
        const blockId = ((_b = possibleBlockId === null || possibleBlockId === void 0 ? void 0 : possibleBlockId.endsWith) === null || _b === void 0 ? void 0 : _b.call(possibleBlockId, blockUid))
            ? possibleBlockId
            : undefined;
        if (blockUid) {
            renderWithUnmount(react_1.default.createElement(ComponentContainer, { blockId: blockId, className: className },
                react_1.default.createElement(Fc, { blockUid: blockUid })), b.parentElement);
        }
    }
};
exports.createComponentRender = createComponentRender;
exports.default = ComponentContainer;
//# sourceMappingURL=ComponentContainer.js.map