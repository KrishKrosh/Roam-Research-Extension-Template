"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.awsGetRoamJSUser = void 0;
const tslib_1 = require("tslib");
const axios_1 = tslib_1.__importDefault(require("axios"));
const headers_1 = tslib_1.__importDefault(require("./headers"));
const getRoamJSUser = ({ token, extensionId = process.env.ROAMJS_EXTENSION_ID || "", email = process.env.ROAMJS_EMAIL, dev = process.env.NODE_ENV === "development", params = {}, }) => {
    const url = new URL(`https://lambda.roamjs.com/user`);
    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
    return axios_1.default
        .get(url.toString(), {
        headers: Object.assign({ Authorization: `Bearer ${Buffer.from(`${email}:${process.env.ROAMJS_DEVELOPER_TOKEN}`).toString("base64")}`, "x-roamjs-token": token, "x-roamjs-extension": extensionId }, (dev
            ? {
                "x-roamjs-dev": "true",
            }
            : {})),
    })
        .then((r) => r.data)
        .catch((e) => {
        var _a, _b;
        return Promise.reject(new Error(typeof ((_a = e.response) === null || _a === void 0 ? void 0 : _a.data) === "object"
            ? e.response.data.message || JSON.stringify(e.response.data)
            : ((_b = e.response) === null || _b === void 0 ? void 0 : _b.data) || e.message));
    });
};
const awsGetRoamJSUser = (handler, params) => (event) => {
    const token = event.headers.Authorization || event.headers.authorization || "";
    return getRoamJSUser({ token, params })
        .then((u) => handler(Object.assign(Object.assign({}, u), { token }), Object.assign(Object.assign({}, event.queryStringParameters), JSON.parse(event.body || "{}"))))
        .catch((e) => ({
        statusCode: 401,
        body: e.message,
        headers: headers_1.default,
    }));
};
exports.awsGetRoamJSUser = awsGetRoamJSUser;
exports.default = getRoamJSUser;
//# sourceMappingURL=getRoamJSUser.js.map